<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>112 Valencia - Sistema de Emergencias</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-slide-in { animation: slideIn 0.3s ease-out; }
        .status-dot { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
    </style>
</head>
<body>
    <div id="root">Cargando...</div>
    
    <script>
      // Manejo del callback de Discord OAuth2
      const params = new URLSearchParams(window.location.search);
      const code = params.get("code");
      if (code) {
        document.getElementById('root').innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(to bottom right, #f8fafc, #e2e8f0);">
            <div style="text-align: center;">
              <div style="width: 64px; height: 64px; border: 4px solid #dbeafe; border-top-color: #2563eb; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 16px;"></div>
              <p style="color: #475569; font-weight: 600; font-size: 18px;">Procesando autenticaci√≥n...</p>
              <p style="color: #94a3b8; font-size: 14px; margin-top: 8px;">Redirigiendo al sistema...</p>
            </div>
          </div>
          <style>@keyframes spin { to { transform: rotate(360deg); } }</style>
        `;
        setTimeout(() => {
          window.location.href = "https://one12-valencia.onrender.com/auth/discord?code=" + code;
        }, 500);
      }
    </script>
    
    <script type="module">
        import { h, render, Component } from 'https://esm.sh/preact';
        import { useState, useEffect } from 'https://esm.sh/preact/hooks';
        import htm from 'https://esm.sh/htm';
        
        const html = htm.bind(h);
        
        // Iconos SVG
        const Phone = ({className = "w-6 h-6"}) => html`<svg class=${className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>`;
        const MapPin = ({className = "w-6 h-6"}) => html`<svg class=${className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>`;
        const AlertCircle = ({className = "w-6 h-6"}) => html`<svg class=${className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>`;
        const User = ({className = "w-6 h-6"}) => html`<svg class=${className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>`;
        const Hash = ({className = "w-6 h-6"}) => html`<svg class=${className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></svg>`;
        const Send = ({className = "w-6 h-6"}) => html`<svg class=${className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>`;
        const LogIn = ({className = "w-6 h-6"}) => html`<svg class=${className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>`;
        const Shield = ({className = "w-6 h-6"}) => html`<svg class=${className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>`;
        const Clock = ({className = "w-6 h-6"}) => html`<svg class=${className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`;
        const CheckCircle = ({className = "w-6 h-6"}) => html`<svg class=${className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`;
        
        function Emergency112() {
          const [formData, setFormData] = useState({ servicio: '', incidente: '', ciudadano: '', ubicacion: '', rangos: 9 });
          const [isSubmitting, setIsSubmitting] = useState(false);
          const [notification, setNotification] = useState({ show: false, message: '', type: '' });
          const [discordUser, setDiscordUser] = useState(null);
          const [isLoadingUser, setIsLoadingUser] = useState(true);
          const [currentTime, setCurrentTime] = useState(new Date());

          const DISCORD_CLIENT_ID = '1457002138868777163';
          const WEBHOOK_URL = 'https://discord.com/api/webhooks/1447737113683562559/R5WwUDWAIwYEoxB6I5ZKIruX3AuIYi_AllPAnVyYbjVNfc7DPliBish9q0GutvwhpMdN';
          const REDIRECT_URI = window.location.origin + window.location.pathname;

          const servicios = [
            { value: 'Polic√≠a Nacional', icon: 'üëÆ‚Äç‚ôÇÔ∏è', color: '#1e40af', description: 'Seguridad Ciudadana' },
            { value: 'SAMU', icon: 'üöë', color: '#dc2626', description: 'Emergencias M√©dicas' },
            { value: 'Bomberos', icon: 'üöí', color: '#ea580c', description: 'Protecci√≥n Civil' }
          ];

          useEffect(() => {
            const timer = setInterval(() => setCurrentTime(new Date()), 1000);
            return () => clearInterval(timer);
          }, []);

          useEffect(() => {
            const token = localStorage.getItem('discord_token');
            const userDataStr = localStorage.getItem('discord_user');
            if (token && userDataStr) {
              try {
                setDiscordUser(JSON.parse(userDataStr));
              } catch (error) {
                localStorage.removeItem('discord_token');
                localStorage.removeItem('discord_user');
              }
            }
            setIsLoadingUser(false);
          }, []);

          const handleDiscordLogin = () => {
            window.location.href = `https://discord.com/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=identify`;
          };

          const handleLogout = () => {
            localStorage.removeItem('discord_token');
            localStorage.removeItem('discord_user');
            setDiscordUser(null);
            showNotification('Sesi√≥n cerrada correctamente', 'success');
          };

          const validateForm = () => {
            if (!discordUser) { showNotification('Debe iniciar sesi√≥n', 'error'); return false; }
            if (!formData.servicio.trim()) { showNotification('Seleccione un servicio', 'error'); return false; }
            if (!formData.incidente.trim()) { showNotification('Describa el incidente', 'error'); return false; }
            if (formData.incidente.length < 10) { showNotification('M√≠nimo 10 caracteres', 'error'); return false; }
            if (!formData.ciudadano.trim()) { showNotification('Ingrese nombre del ciudadano', 'error'); return false; }
            if (!formData.ubicacion.trim()) { showNotification('Especifique ubicaci√≥n', 'error'); return false; }
            return true;
          };

          const handleSubmit = async () => {
            if (!validateForm()) return;
            setIsSubmitting(true);

            try {
              const servicioSeleccionado = servicios.find(s => s.value === formData.servicio);
              const embed = {
                title: "üö® ALERTA VERIFICADA:",
                description: `**${formData.servicio}**\n\n**${formData.incidente}**`,
                color: parseInt(servicioSeleccionado.color.replace('#', ''), 16),
                fields: [
                  { name: "üë§ Ciudadano (IC)", value: formData.ciudadano, inline: false },
                  { name: "üìç Ubicaci√≥n", value: formData.ubicacion, inline: false },
                  { name: "üîí Identidad Verificada", value: "‚úì Confirmada", inline: false },
                  { name: "Solicitado por:", value: `@${discordUser.username}`, inline: false }
                ],
                footer: { text: `@ Rangos Policiales: ${formData.rangos}`, icon_url: "https://cdn.discordapp.com/embed/avatars/0.png" },
                timestamp: new Date().toISOString(),
                thumbnail: { url: discordUser.avatar ? `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png` : 'https://cdn.discordapp.com/embed/avatars/0.png' }
              };

              const response = await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: 'Central 112 Valencia', avatar_url: 'https://cdn-icons-png.flaticon.com/512/3588/3588592.png', embeds: [embed] })
              });

              if (response.ok || response.status === 204) {
                showNotification('‚úì Emergencia reportada exitosamente', 'success');
                setFormData({ servicio: '', incidente: '', ciudadano: '', ubicacion: '', rangos: 9 });
              } else {
                showNotification('Error al procesar la solicitud', 'error');
              }
            } catch (error) {
              showNotification('Error de conexi√≥n', 'error');
            } finally {
              setIsSubmitting(false);
            }
          };

          const showNotification = (message, type) => {
            setNotification({ show: true, message, type });
            setTimeout(() => setNotification({ show: false, message: '', type: '' }), 4000);
          };

          if (isLoadingUser) {
            return html`<div class="min-h-screen bg-slate-50 flex items-center justify-center"><div class="text-center"><div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div><p class="text-slate-600 font-semibold">Cargando sistema...</p></div></div>`;
          }

          return html`
            <div class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
              <header class="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-50">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 py-4">
                  <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div class="flex items-center gap-3">
                      <div class="w-12 h-12 bg-red-600 rounded-lg flex items-center justify-center"><${Phone} className="w-7 h-7 text-white" /></div>
                      <div><h1 class="text-xl sm:text-2xl font-bold text-slate-900">112 Valencia</h1><p class="text-xs sm:text-sm text-slate-600">Sistema de Gesti√≥n de Emergencias</p></div>
                    </div>
                    <div class="flex items-center gap-4">
                      <div class="flex items-center gap-2 text-slate-600"><${Clock} className="w-4 h-4" /><span class="text-sm font-medium">${currentTime.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}</span></div>
                      ${discordUser && html`
                        <div class="flex items-center gap-2 bg-slate-50 px-3 py-2 rounded-lg border border-slate-200">
                          <img src=${discordUser.avatar ? `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png` : 'https://cdn.discordapp.com/embed/avatars/0.png'} alt="Avatar" class="w-8 h-8 rounded-full" />
                          <div class="text-left hidden sm:block"><p class="text-sm font-semibold text-slate-900">${discordUser.username}</p><p class="text-xs text-slate-500">Operador</p></div>
                          <button onClick=${handleLogout} class="ml-2 text-xs text-slate-500 hover:text-slate-700 font-medium">Salir</button>
                        </div>
                      `}
                    </div>
                  </div>
                </div>
              </header>

              <main class="max-w-7xl mx-auto px-4 sm:px-6 py-8">
                ${!discordUser ? html`
                  <div class="max-w-md mx-auto mt-20">
                    <div class="bg-white rounded-2xl shadow-lg border border-slate-200 p-8 sm:p-10 text-center">
                      <div class="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6"><${Shield} className="w-10 h-10 text-blue-600" /></div>
                      <h2 class="text-2xl font-bold text-slate-900 mb-3">Autenticaci√≥n Requerida</h2>
                      <p class="text-slate-600 mb-2">Para acceder al sistema es necesario verificar su identidad.</p>
                      <p class="text-sm text-slate-500 mb-8">Inicie sesi√≥n con Discord para continuar.</p>
                      <button onClick=${handleDiscordLogin} class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-3"><${LogIn} className="w-5 h-5" />Iniciar Sesi√≥n con Discord</button>
                    </div>
                  </div>
                ` : html`
                  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2"><${AlertCircle} className="w-5 h-5 text-red-600" />Seleccionar Servicio de Emergencia</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                          ${servicios.map((servicio) => html`
                            <button key=${servicio.value} onClick=${() => setFormData({...formData, servicio: servicio.value})} class="${formData.servicio === servicio.value ? 'border-blue-600 bg-blue-50 shadow-md scale-105' : 'border-slate-200 hover:border-slate-300 hover:bg-slate-50'} relative p-6 rounded-xl border-2 transition-all">
                              <div class="text-center"><div class="text-4xl mb-2">${servicio.icon}</div><p class="font-semibold text-slate-900 text-sm mb-1">${servicio.value}</p><p class="text-xs text-slate-500">${servicio.description}</p></div>
                              ${formData.servicio === servicio.value && html`<div class="absolute top-2 right-2"><${CheckCircle} className="w-5 h-5 text-blue-600" /></div>`}
                            </button>
                          `)}
                        </div>
                      </div>

                      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4">Informaci√≥n del Incidente</h3>
                        <div class="space-y-4">
                          <div><label class="block text-sm font-semibold text-slate-700 mb-2">Tipo de Incidente *</label><input type="text" value=${formData.incidente} onInput=${(e) => setFormData({...formData, incidente: e.target.value})} placeholder="Describa brevemente la situaci√≥n" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-slate-900" maxLength="200" /><p class="text-xs text-slate-500 mt-1">${formData.incidente.length}/200 caracteres</p></div>
                          <div><label class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2"><${User} className="w-4 h-4" />Ciudadano Afectado (IC) *</label><input type="text" value=${formData.ciudadano} onInput=${(e) => setFormData({...formData, ciudadano: e.target.value})} placeholder="Nombre completo" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-slate-900" /></div>
                          <div><label class="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2"><${MapPin} className="w-4 h-4" />Ubicaci√≥n Exacta *</label><input type="text" value=${formData.ubicacion} onInput=${(e) => setFormData({...formData, ubicacion: e.target.value})} placeholder="Direcci√≥n o punto de referencia" class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-slate-900" /></div>
                        </div>
                      </div>

                      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 class="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2"><${Hash} className="w-5 h-5" />Rangos Policiales a Notificar</h3>
                        <div class="space-y-3">
                          <div class="flex items-center justify-between"><span class="text-sm font-medium text-slate-700">Nivel de alerta:</span><span class="text-2xl font-bold text-blue-600">${formData.rangos}</span></div>
                          <input type="range" min="1" max="20" value=${formData.rangos} onInput=${(e) => setFormData({...formData, rangos: parseInt(e.target.value)})} class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600" />
                          <div class="flex justify-between text-xs text-slate-500 font-medium"><span>M√≠nimo (1)</span><span>M√°ximo (20)</span></div>
                        </div>
                      </div>
                    </div>

                    <div class="space-y-6">
                      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 class="text-sm font-bold text-slate-700 mb-4 uppercase tracking-wide">Operador del Sistema</h3>
                        <div class="flex items-start gap-3 mb-4">
                          <img src=${discordUser.avatar ? `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png` : 'https://cdn.discordapp.com/embed/avatars/0.png'} alt="Avatar" class="w-16 h-16 rounded-lg border-2 border-slate-200" />
                          <div class="flex-1"><p class="font-bold text-slate-900 text-lg">${discordUser.username}</p><div class="flex items-center gap-1 mt-1"><div class="w-2 h-2 bg-green-500 rounded-full status-dot"></div><span class="text-xs text-slate-600">Verificado y activo</span></div></div>
                        </div>
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3 flex items-center gap-2"><${Shield} className="w-5 h-5 text-green-600 flex-shrink-0" /><div><p class="text-xs font-semibold text-green-900">Identidad Verificada</p><p class="text-xs text-green-700">Autorizado para reportes</p></div></div>
                      </div>

                      <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 class="text-sm font-bold text-slate-700 mb-4 uppercase tracking-wide">Estado del Sistema</h3>
                        <div class="space-y-3">
                          <div class="flex items-center justify-between"><span class="text-sm text-slate-600">Conexi√≥n</span><span class="text-sm font-semibold text-green-600 flex items-center gap-1"><div class="w-2 h-2 bg-green-500 rounded-full status-dot"></div>Activa</span></div>
                          <div class="flex items-center justify-between"><span class="text-sm text-slate-600">Webhook</span><span class="text-sm font-semibold text-green-600 flex items-center gap-1"><div class="w-2 h-2 bg-green-500 rounded-full status-dot"></div>Operativo</span></div>
                          <div class="flex items-center justify-between"><span class="text-sm text-slate-600">Servicios</span><span class="text-sm font-semibold text-green-600 flex items-center gap-1"><div class="w-2 h-2 bg-green-500 rounded-full status-dot"></div>Disponibles</span></div>
                        </div>
                      </div>

                      <button onClick=${handleSubmit} disabled=${isSubmitting} class="w-full bg-red-600 hover:bg-red-700 disabled:bg-slate-400 disabled:cursor-not-allowed text-white font-bold py-4 rounded-xl transition-all shadow-lg flex items-center justify-center gap-3 text-lg">
                        ${isSubmitting ? html`<><div class="w-5 h-5 border-3 border-white border-t-transparent rounded-full animate-spin"></div>Procesando...</>` : html`<><${Send} className="w-6 h-6" />Reportar Emergencia</>`}
                      </button>
                      <p class="text-xs text-center text-slate-500">Al enviar, confirma que la informaci√≥n es ver√≠dica y urgente.</p>
                    </div>
                  </div>
                `}
              </main>

              ${notification.show && html`
                <div class="fixed top-6 right-6 z-50 animate-slide-in">
                  <div class="${notification.type === 'success' ? 'bg-green-600 border-green-700' : 'bg-red-600 border-red-700'} border-2 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 min-w-[300px]">
                    ${notification.type === 'success' ? html`<${CheckCircle} className="w-6 h-6 flex-shrink-0" />` : html`<${AlertCircle} className="w-6 h-6 flex-shrink-0" />`}
                    <p class="font-semibold">${notification.message}</p>
                  </div>
                </div>
              `}
            </div>
          `;
        }

        render(html`<${Emergency112} />`, document.getElementById('root'));
    </script>
</body>
</html>

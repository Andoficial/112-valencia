<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>112 Valencia - Sistema de Emergencias</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Animaciones personalizadas para modernidad */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        /* Modo oscuro opcional */
        @media (prefers-color-scheme: dark) {
            body { background: linear-gradient(to br, #1e293b, #0f172a); color: #e2e8f0; }
            .card { background: #1e293b; border-color: #334155; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-slate-100 min-h-screen">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // Iconos SVG (mantenidos para consistencia)
        const Phone = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>;
        const MapPin = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>;
        const AlertCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;
        const User = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
        const Hash = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></svg>;
        const Send = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>;
        const LogIn = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>;
        const Shield = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>;
        const Clock = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
        const CheckCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
        const AlertTriangle = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>;

        function Emergency112() {
          const [formData, setFormData] = useState({
            servicio: '',
            incidente: '',
            ciudadano: '',
            ubicacion: '',
            rangos: 9
          });
          const [isSubmitting, setIsSubmitting] = useState(false);
          const [notification, setNotification] = useState({ show: false, message: '', type: '' });
          const [discordUser, setDiscordUser] = useState(null);
          const [isLoadingUser, setIsLoadingUser] = useState(true);
          const [currentTime, setCurrentTime] = useState(new Date());

          const DISCORD_CLIENT_ID = '1457002138868777163';
          const REDIRECT_URI = window.location.origin + window.location.pathname;
          const SCOPES = 'identify';

          const servicios = [
            { 
              value: 'PolicÃ­a Nacional', 
              icon: 'ðŸ‘®', 
              color: '#1e40af',
              description: 'Seguridad Ciudadana'
            },
            { 
              value: 'SAMU', 
              icon: 'ðŸš‘', 
              color: '#dc2626',
              description: 'Emergencias MÃ©dicas'
            },
            { 
              value: 'Bomberos', 
              icon: 'ðŸš’', 
              color: '#ea580c',
              description: 'ProtecciÃ³n Civil'
            }
          ];

          // FunciÃ³n para determinar el nivel de prioridad basado en rangos
          const getPriorityLevel = (rangos) => {
            if (rangos <= 5) return { level: 'Baja', color: 0x00ff00, emoji: 'ðŸŸ¢' }; // Verde
            if (rangos <= 10) return { level: 'Media', color: 0xffff00, emoji: 'ðŸŸ¡' }; // Amarillo
            return { level: 'Alta', color: 0xff0000, emoji: 'ðŸ”´' }; // Rojo
          };

          useEffect(() => {
            const timer = setInterval(() => setCurrentTime(new Date()), 1000);
            return () => clearInterval(timer);
          }, []);

          useEffect(() => {
            const token = localStorage.getItem('discord_token');
            if (token) {
              fetchDiscordUser(token);
            } else {
              const fragment = new URLSearchParams(window.location.hash.slice(1));
              const accessToken = fragment.get('access_token');
              
              if (accessToken) {
                localStorage.setItem('discord_token', accessToken);
                fetchDiscordUser(accessToken);
                window.history.replaceState({}, document.title, window.location.pathname);
              } else {
                setIsLoadingUser(false);
              }
            }
          }, []);

          const fetchDiscordUser = async (token) => {
            try {
              const response = await fetch('https://discord.com/api/users/@me', {
                headers: {
                  Authorization: `Bearer ${token}`
                }
              });

              if (response.ok) {
                const userData = await response.json();
                setDiscordUser(userData);
              } else {
                localStorage.removeItem('discord_token');
              }
            } catch (error) {
              console.error('Error fetching Discord user:', error);
              localStorage.removeItem('discord_token');
            } finally {
              setIsLoadingUser(false);
            }
          };

          const handleDiscordLogin = () => {
            const authUrl = 'https://discord.com/oauth2/authorize?client_id=1457002138868777163&response_type=token&redirect_uri=https%3A%2F%2Fandoficial.github.io%2F112-valencia%2F&scope=identify';
            window.location.href = authUrl;
          };

          const handleLogout = () => {
            localStorage.removeItem('discord_token');
            setDiscordUser(null);
          };

          const handleSubmit = async () => {
            if (!discordUser) {
              showNotification('AutenticaciÃ³n requerida', 'error');
              return;
            }

            if (!formData.servicio || !formData.incidente || !formData.ciudadano || !formData.ubicacion) {
              showNotification('Complete todos los campos obligatorios', 'error');
              return;
            }

            setIsSubmitting(true);

            const servicioSeleccionado = servicios.find(s => s.value === formData.servicio);
            const solicitadoPor = `@${discordUser.username}`;
            const priority = getPriorityLevel(formData.rangos);
            
            // Embed mejorado: mÃ¡s profesional, moderno y con prioridad
            const embed = {
              title: `ðŸš¨ Emergencia Reportada - Prioridad ${priority.level} ${priority.emoji}`,
              description: `**Servicio Solicitado:** ${formData.servicio}\n**DescripciÃ³n del Incidente:** ${formData.incidente}`,
              color: priority.color, // Color basado en prioridad para mayor impacto
              fields: [
                {
                  name: "ðŸ‘¤ Ciudadano Afectado (IC)",
                  value: formData.ciudadano,
                  inline: true
                },
                {
                  name: "ðŸ“ UbicaciÃ³n Exacta",
                  value: formData.ubicacion,
                  inline: true
                },
                {
                  name: "âš ï¸ Nivel de Prioridad",
                  value: `${priority.level} (${formData.rangos}/20)`,
                  inline: true
                },
                {
                  name: "ðŸ”’ Estado de VerificaciÃ³n",
                  value: "âœ… Identidad Confirmada - Reporte AutÃ©ntico",
                  inline: false
                },
                {
                  name: "ðŸ‘¨â€ðŸ’¼ Operador Responsable",
                  value: solicitadoPor,
                  inline: false
                }
              ],
              footer: {
                text: "Sistema 112 Valencia - Emergencias Verificadas | Reportado el " + new Date().toLocaleString('es-ES'),
                icon_url: "https://cdn-icons-png.flaticon.com/512/3588/3588592.png"
              },
              timestamp: new Date().toISOString(),
              thumbnail: {
                url: "https://cdn-icons-png.flaticon.com/512/3588/3588592.png" // Icono representativo
              }
            };

            try {
              const response = await fetch('https://discord.com/api/webhooks/1447737113683562559/R5WwUDWAIwYEoxB6I5ZKIruX3AuIYi_AllPAnVyYbjVNfc7DPliBish9q0GutvwhpMdN', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  username: 'Central 112 Valencia - Emergencias',
                  avatar_url: 'https://cdn-icons-png.flaticon.com/512/3588/3588592.png',
                  embeds: [embed]
                })
              });

              if (response.ok || response.status === 204) {
                showNotification('âœ… Emergencia reportada exitosamente', 'success');
                setFormData({
                  servicio: '',
                  incidente: '',
                  ciudadano: '',
                  ubicacion: '',
                  rangos: 9
                });
              } else {
                showNotification('âŒ Error al procesar la solicitud', 'error');
              }
            } catch (error) {
              showNotification('âŒ Error de conexiÃ³n con el servidor', 'error');
            } finally {
              setIsSubmitting(false);
            }
          };

          const showNotification = (message, type) => {
            setNotification({ show: true, message, type });
            setTimeout(() => setNotification({ show: false, message: '', type: '' }), 4000);
          };

          if (isLoadingUser) {
            return (
              <div className="min-h-screen bg-slate-50 flex items-center justify-center">
                <div className="text-center fade-in">
                  <div className="w-16 h-16 border-4 border-blue-200 border-t-blue-600

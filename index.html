<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>112 Valencia - Sistema de Emergencias</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const Phone = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>;
        const MapPin = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>;
        const AlertCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;
        const User = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
        const Hash = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></svg>;
        const Send = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>;
        const LogIn = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path><polyline points="10 17 15 12 10 7"></polyline><line x1="15" y1="12" x2="3" y2="12"></line></svg>;
        const Shield = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>;
        const Clock = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
        const CheckCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;
        const AlertTriangle = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>;

        function Emergency112() {
          const [formData, setFormData] = useState({
            servicio: '',
            incidente: '',
            ciudadano: '',
            ubicacion: '',
            prioridad: 'MEDIA',
            rangos: 9
          });
          const [isSubmitting, setIsSubmitting] = useState(false);
          const [notification, setNotification] = useState({ show: false, message: '', type: '' });
          const [discordUser, setDiscordUser] = useState(null);
          const [isLoadingUser, setIsLoadingUser] = useState(true);
          const [currentTime, setCurrentTime] = useState(new Date());

          const servicios = [
            { value: 'Polic√≠a Nacional', icon: 'üëÆ', color: '#1e40af', emoji: 'üöî' },
            { value: 'SAMU', icon: 'üöë', color: '#dc2626', emoji: 'üè•' },
            { value: 'Bomberos', icon: 'üöí', color: '#ea580c', emoji: 'üî•' }
          ];

          const prioridades = [
            { value: 'BAJA', label: 'Baja', color: 'bg-blue-100 text-blue-800 border-blue-300', icon: 'üîµ' },
            { value: 'MEDIA', label: 'Media', color: 'bg-yellow-100 text-yellow-800 border-yellow-300', icon: 'üü°' },
            { value: 'ALTA', label: 'Alta', color: 'bg-orange-100 text-orange-800 border-orange-300', icon: 'üü†' },
            { value: 'CR√çTICA', label: 'Cr√≠tica', color: 'bg-red-100 text-red-800 border-red-300', icon: 'üî¥' }
          ];

          useEffect(() => {
            const timer = setInterval(() => setCurrentTime(new Date()), 1000);
            return () => clearInterval(timer);
          }, []);

          useEffect(() => {
            const token = localStorage.getItem('discord_token');
            if (token) {
              fetchDiscordUser(token);
            } else {
              const fragment = new URLSearchParams(window.location.hash.slice(1));
              const accessToken = fragment.get('access_token');
              
              if (accessToken) {
                localStorage.setItem('discord_token', accessToken);
                fetchDiscordUser(accessToken);
                window.history.replaceState({}, document.title, window.location.pathname);
              } else {
                setIsLoadingUser(false);
              }
            }
          }, []);

          const fetchDiscordUser = async (token) => {
            try {
              const response = await fetch('https://discord.com/api/users/@me', {
                headers: { Authorization: `Bearer ${token}` }
              });
              if (response.ok) {
                const userData = await response.json();
                setDiscordUser(userData);
              } else {
                localStorage.removeItem('discord_token');
              }
            } catch (error) {
              localStorage.removeItem('discord_token');
            } finally {
              setIsLoadingUser(false);
            }
          };

          const handleDiscordLogin = () => {
            window.location.href = 'https://discord.com/oauth2/authorize?client_id=1457002138868777163&response_type=token&redirect_uri=https%3A%2F%2Fandoficial.github.io%2F112-valencia%2F&scope=identify';
          };

          const handleLogout = () => {
            localStorage.removeItem('discord_token');
            setDiscordUser(null);
            showNotification('Sesi√≥n cerrada correctamente', 'success');
          };

          const handleSubmit = async () => {
            if (!discordUser) {
              showNotification('Debe iniciar sesi√≥n', 'error');
              return;
            }
            if (!formData.servicio || !formData.incidente || !formData.ciudadano || !formData.ubicacion) {
              showNotification('Complete todos los campos', 'error');
              return;
            }

            setIsSubmitting(true);
            try {
              const servicio = servicios.find(s => s.value === formData.servicio);
              const prioridad = prioridades.find(p => p.value === formData.prioridad);
              const timestamp = new Date();
              
              const embed = {
                title: `üö® ALERTA DE EMERGENCIA - ${formData.prioridad}`,
                description: `**${servicio.emoji} ${formData.servicio}**\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n### üìã Descripci√≥n\n${formData.incidente}\n\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ`,
                color: parseInt(servicio.color.replace('#', ''), 16),
                fields: [
                  { name: `${prioridad.icon} Prioridad`, value: `\`${formData.prioridad}\``, inline: true },
                  { name: "üìä Rangos", value: `\`${formData.rangos}\``, inline: true },
                  { name: "\u200b", value: "\u200b", inline: false },
                  { name: "üë§ Ciudadano (IC)", value: `\`${formData.ciudadano}\``, inline: false },
                  { name: "üìç Ubicaci√≥n", value: `\`${formData.ubicacion}\``, inline: false },
                  { name: "\u200b", value: "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ", inline: false },
                  { name: "üë®‚Äçüíº Operador", value: `<@${discordUser.id}> ‚Ä¢ \`${discordUser.username}\``, inline: true },
                  { name: "üîí Verificaci√≥n", value: "`‚úì Confirmada`", inline: true },
                  { name: "\u200b", value: "\u200b", inline: false },
                  { name: "üìÖ Fecha", value: `\`${timestamp.toLocaleDateString('es-ES')}\``, inline: true },
                  { name: "‚è∞ Hora", value: `\`${timestamp.toLocaleTimeString('es-ES')}\``, inline: true }
                ],
                footer: { text: "112 Valencia ‚Ä¢ Sistema de Emergencias", icon_url: "https://cdn-icons-png.flaticon.com/512/3588/3588592.png" },
                timestamp: timestamp.toISOString(),
                thumbnail: { url: `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png` }
              };

              const response = await fetch('https://discord.com/api/webhooks/1447737113683562559/R5WwUDWAIwYEoxB6I5ZKIruX3AuIYi_AllPAnVyYbjVNfc7DPliBish9q0GutvwhpMdN', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  content: `@everyone\n\n‚ö†Ô∏è **NUEVA EMERGENCIA** ‚ö†Ô∏è\n**Prioridad:** ${formData.prioridad} ${prioridad.icon}\n**Servicio:** ${servicio.value} ${servicio.emoji}`,
                  username: 'Central 112 Valencia',
                  avatar_url: 'https://cdn-icons-png.flaticon.com/512/3588/3588592.png',
                  embeds: [embed]
                })
              });

              if (response.ok || response.status === 204) {
                showNotification('‚úì Emergencia reportada', 'success');
                setFormData({ servicio: '', incidente: '', ciudadano: '', ubicacion: '', prioridad: 'MEDIA', rangos: 9 });
              } else {
                showNotification('Error al enviar', 'error');
              }
            } catch (error) {
              showNotification('Error de conexi√≥n', 'error');
            } finally {
              setIsSubmitting(false);
            }
          };

          const showNotification = (message, type) => {
            setNotification({ show: true, message, type });
            setTimeout(() => setNotification({ show: false, message: '', type: '' }), 4000);
          };

          if (isLoadingUser) {
            return (
              <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center">
                <div className="text-center">
                  <div className="w-16 h-16 border-4 border-red-200 border-t-red-600 rounded-full animate-spin mx-auto mb-4"></div>
                  <p className="text-slate-600 font-semibold">Cargando sistema...</p>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
              <header className="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-50">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 py-4">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 bg-gradient-to-br from-red-600 to-orange-600 rounded-xl flex items-center justify-center shadow-lg">
                        <Phone />
                      </div>
                      <div>
                        <h1 className="text-2xl font-black text-red-600">112 Valencia</h1>
                        <p className="text-xs text-slate-600">Sistema de Emergencias</p>
                      </div>
                    </div>
                    
                    <div className="flex items-center gap-4">
                      <div className="flex items-center gap-2 text-slate-600">
                        <Clock />
                        <span className="text-sm font-medium">
                          {currentTime.toLocaleTimeString('es-ES')}
                        </span>
                      </div>
                      
                      {discordUser && (
                        <div className="flex items-center gap-3 bg-green-50 px-4 py-2 rounded-lg border border-green-200">
                          <img 
                            src={`https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png`}
                            alt="Avatar"
                            className="w-8 h-8 rounded-full"
                          />
                          <div className="text-left hidden sm:block">
                            <p className="text-sm font-bold text-slate-900">{discordUser.username}</p>
                            <p className="text-xs text-green-700">Activo</p>
                          </div>
                          <button onClick={handleLogout} className="text-xs text-slate-500 hover:text-red-600 font-medium">
                            Salir
                          </button>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </header>

              <main className="max-w-7xl mx-auto px-4 sm:px-6 py-8">
                {!discordUser ? (
                  <div className="max-w-md mx-auto mt-20">
                    <div className="bg-white rounded-2xl shadow-xl border border-slate-200 p-10 text-center">
                      <div className="w-20 h-20 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-6">
                        <Shield />
                      </div>
                      <h2 className="text-2xl font-bold text-slate-900 mb-3">Autenticaci√≥n Requerida</h2>
                      <p className="text-slate-600 mb-8">Inicie sesi√≥n con Discord para continuar</p>
                      <button
                        onClick={handleDiscordLogin}
                        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg flex items-center justify-center gap-3"
                      >
                        <LogIn />
                        Iniciar Sesi√≥n con Discord
                      </button>
                    </div>
                  </div>
                ) : (
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div className="lg:col-span-2 space-y-6">
                      <div className="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                        <h3 className="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                          <AlertCircle />
                          Servicio de Emergencia
                        </h3>
                        <div className="grid grid-cols-3 gap-4">
                          {servicios.map((servicio) => (
                            <button
                              key={servicio.value}
                              onClick={() => setFormData({...formData, servicio: servicio.value})}
                              className={`p-6 rounded-xl border-2 transition-all ${
                                formData.servicio === servicio.value
                                  ? 'border-blue-600 bg-blue-50 shadow-md'
                                  : 'border-slate-200 hover:border-slate-300'
                              }`}
                            >
                              <div className="text-4xl mb-2">{servicio.icon}</div>
                              <p className="font-semibold text-sm">{servicio.value}</p>
                              {formData.servicio === servicio.value && (
                                <div className="mt-2">
                                  <CheckCircle />
                                </div>
                              )}
                            </button>
                          ))}
                        </div>
                      </div>

                      <div className="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                        <h3 className="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                          <AlertTriangle />
                          Nivel de Prioridad
                        </h3>
                        <div className="grid grid-cols-4 gap-3">
                          {prioridades.map((prior) => (
                            <button
                              key={prior.value}
                              onClick={() => setFormData({...formData, prioridad: prior.value})}
                              className={`p-4 rounded-xl border-2 transition-all ${
                                formData.prioridad === prior.value
                                  ? prior.color + ' border-current'
                                  : 'border-slate-200'
                              }`}
                            >
                              <div className="text-2xl mb-1">{prior.icon}</div>
                              <p className="text-xs font-bold">{prior.label}</p>
                            </button>
                          ))}
                        </div>
                      </div>

                      <div className="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                        <h3 className="text-lg font-bold text-slate-900 mb-4">Informaci√≥n del Incidente</h3>
                        <div className="space-y-4">
                          <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-2">
                              Tipo de Incidente *
                            </label>
                            <input
                              type="text"
                              value={formData.incidente}
                              onChange={(e) => setFormData({...formData, incidente: e.target.value})}
                              placeholder="Describa la emergencia"
                              className="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                            />
                          </div>

                          <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-2">
                              <User /> Ciudadano (IC) *
                            </label>
                            <input
                              type="text"
                              value={formData.ciudadano}
                              onChange={(e) => setFormData({...formData, ciudadano: e.target.value})}
                              placeholder="Nombre del ciudadano"
                              className="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                            />
                          </div>

                          <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-2">
                              <MapPin /> Ubicaci√≥n *
                            </label>
                            <input
                              type="text"
                              value={formData.ubicacion}
                              onChange={(e) => setFormData({...formData, ubicacion: e.target.value})}
                              placeholder="Ubicaci√≥n exacta"
                              className="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                            />
                          </div>
                        </div>
                      </div>

                      <div className="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                        <h3 className="text-lg font-bold text-slate-900 mb-4">
                          <Hash /> Rangos Policiales: {formData.rangos}
                        </h3>
                        <input
                          type="range"
                          min="1"
                          max="20"
                          value={formData.rangos}
                          onChange={(e) => setFormData({...formData, rangos: parseInt(e.target.value)})}
                          className="w-full h-2 bg-slate-200 rounded-lg cursor-pointer accent-blue-600"
                        />
                        <div className="flex justify-between text-xs text-slate-500 mt-2">
                          <span>1</span>
                          <span>20</span>
                        </div>
                      </div>
                    </div>

                    <div className="space-y-6">
                      <div className="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                        <h3 className="text-sm font-bold text-slate-700 mb-4 uppercase">Operador</h3>
                        <div className="flex items-start gap-3 mb-4">
                          <img 
                            src={`https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png`}
                            className="w-16 h-16 rounded-lg"
                          />
                          <div>
                            <p className="font-bold text-lg">{discordUser.username}</p>
                            <p className="text-xs text-green-600">‚úì Verificado</p>
                          </div>
                        </div>
                      </div>

                      <div className="bg-white rounded-xl shadow-lg border border-slate-200 p-6">
                        <h3 className="text-sm font-bold text-slate-700 mb-4 uppercase">Estado</h3>
                        <div className="space-y-2">
                          <div className="flex justify-between">
                            <span className="text-sm">Conexi√≥n</span>
                            <span className="text-sm text-green-600">‚óè Activa</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-sm">Webhook</span>
                            <span className="text-sm text-green-600">‚óè Operativo</span>
                          </div>
                        </div>
                      </div>

                      <button
                        onClick={handleSubmit}
                        disabled={isSubmitting}
                        className="w-full bg-red-600 hover:bg-red-700 disabled:bg-slate-300 text-white font-bold py-4 rounded-xl flex items-center justify-center gap-3"
                      >
                        {isSubmitting ? (
                          <>
                            <div className="w-5 h-5 border-3 border-white border-t-transparent rounded-full animate-spin"></div>
                            Enviando...
                          </>
                        ) : (
                          <>
                            <Send />
                            Reportar Emergencia
                          </>
                        )}
                      </button>
                    </div>
                  </div>
                )}
              </main>

              {notification.show && (
                <div className="fixed top-6 right-6 z-50">
                  <div className={`${
                    notification.type === 'success' ? 'bg-green-600' : 'bg-red-600'
                  } text-white px-6 py-4 rounded-lg shadow-xl flex items-center gap-3`}>
                    {notification.type === 'success' ? <CheckCircle /> : <AlertCircle />}
                    <p className="font-semibold">{notification.message}</p>
                  </div>
                </div>
              )}
            </div>
          );
        }

        ReactDOM.render(React.createElement(Emergency112), document.getElementById('root'));
    </script>
</body>
</html>

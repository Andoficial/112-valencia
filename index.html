<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Sistema de Gesti√≥n de Emergencias 112 Valencia">
    <title>112 Valencia - Sistema de Emergencias</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .animate-slide-in {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .status-dot {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // Componentes de Iconos SVG
        const Phone = ({className = "w-6 h-6"}) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
            </svg>
        );

        const MapPin = ({className = "w-6 h-6"}) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                <circle cx="12" cy="10" r="3"></circle>
            </svg>
        );

        const AlertCircle = ({className = "w-6 h-6"}) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        );

        const User = ({className = "w-6 h-6"}) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        );

        const Hash = ({className = "w-6 h-6"}) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="4" y1="9" x2="20" y2="9"></line>
                <line x1="4" y1="15" x2="20" y2="15"></line>
                <line x1="10" y1="3" x2="8" y2="21"></line>
                <line x1="16" y1="3" x2="14" y2="21"></line>
            </svg>
        );

        const Send = ({className = "w-6 h-6"}) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        );

        const LogIn = ({className = "w-6 h-6"}) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                <polyline points="10 17 15 12 10 7"></polyline>
                <line x1="15" y1="12" x2="3" y2="12"></line>
            </svg>
        );

        const Shield = ({className = "w-6 h-6"}) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
            </svg>
        );

        const Clock = ({className = "w-6 h-6"}) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        );

        const CheckCircle = ({className = "w-6 h-6"}) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        );

        const XCircle = ({className = "w-6 h-6"}) => (
            <svg className={className} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="15" y1="9" x2="9" y2="15"></line>
                <line x1="9" y1="9" x2="15" y2="15"></line>
            </svg>
        );

        // Componente Principal
        function Emergency112() {
          const [formData, setFormData] = useState({
            servicio: '',
            incidente: '',
            ciudadano: '',
            ubicacion: '',
            rangos: 9
          });
          const [isSubmitting, setIsSubmitting] = useState(false);
          const [notification, setNotification] = useState({ show: false, message: '', type: '' });
          const [discordUser, setDiscordUser] = useState(null);
          const [isLoadingUser, setIsLoadingUser] = useState(true);
          const [currentTime, setCurrentTime] = useState(new Date());

          // Configuraci√≥n
          const DISCORD_CLIENT_ID = '1457002138868777163';
          const WEBHOOK_URL = 'https://discord.com/api/webhooks/1447737113683562559/R5WwUDWAIwYEoxB6I5ZKIruX3AuIYi_AllPAnVyYbjVNfc7DPliBish9q0GutvwhpMdN';
          const REDIRECT_URI = window.location.origin + window.location.pathname;
          const SCOPES = 'identify';

          const servicios = [
            { 
              value: 'Polic√≠a Nacional', 
              icon: 'üëÆ‚Äç‚ôÇÔ∏è', 
              color: '#1e40af',
              description: 'Seguridad Ciudadana'
            },
            { 
              value: 'SAMU', 
              icon: 'üöë', 
              color: '#dc2626',
              description: 'Emergencias M√©dicas'
            },
            { 
              value: 'Bomberos', 
              icon: 'üöí', 
              color: '#ea580c',
              description: 'Protecci√≥n Civil'
            }
          ];

          // Actualizar reloj cada segundo
          useEffect(() => {
            const timer = setInterval(() => {
              setCurrentTime(new Date());
            }, 1000);
            return () => clearInterval(timer);
          }, []);

          // Verificar autenticaci√≥n al cargar
          useEffect(() => {
            const token = localStorage.getItem('discord_token');
            
            if (token) {
              fetchDiscordUser(token);
            } else {
              // Verificar si hay token en la URL (callback de OAuth2)
              const hash = window.location.hash;
              if (hash) {
                const fragment = new URLSearchParams(hash.slice(1));
                const accessToken = fragment.get('access_token');
                
                if (accessToken) {
                  localStorage.setItem('discord_token', accessToken);
                  fetchDiscordUser(accessToken);
                  // Limpiar URL
                  window.history.replaceState({}, document.title, window.location.pathname);
                } else {
                  setIsLoadingUser(false);
                }
              } else {
                setIsLoadingUser(false);
              }
            }
          }, []);

          // Obtener datos del usuario de Discord
          const fetchDiscordUser = async (token) => {
            try {
              const response = await fetch('https://discord.com/api/users/@me', {
                headers: {
                  'Authorization': `Bearer ${token}`
                }
              });

              if (response.ok) {
                const userData = await response.json();
                setDiscordUser(userData);
              } else {
                console.error('Error al obtener usuario:', response.status);
                localStorage.removeItem('discord_token');
                setIsLoadingUser(false);
              }
            } catch (error) {
              console.error('Error de red:', error);
              localStorage.removeItem('discord_token');
            } finally {
              setIsLoadingUser(false);
            }
          };

          // Iniciar sesi√≥n con Discord
          const handleDiscordLogin = () => {
            const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${SCOPES}`;
            window.location.href = authUrl;
          };

          // Cerrar sesi√≥n
          const handleLogout = () => {
            localStorage.removeItem('discord_token');
            setDiscordUser(null);
            showNotification('Sesi√≥n cerrada correctamente', 'success');
          };

          // Validar formulario
          const validateForm = () => {
            if (!discordUser) {
              showNotification('Debe iniciar sesi√≥n para continuar', 'error');
              return false;
            }

            if (!formData.servicio.trim()) {
              showNotification('Seleccione un servicio de emergencia', 'error');
              return false;
            }

            if (!formData.incidente.trim()) {
              showNotification('Describa el tipo de incidente', 'error');
              return false;
            }

            if (formData.incidente.length < 10) {
              showNotification('La descripci√≥n del incidente debe tener al menos 10 caracteres', 'error');
              return false;
            }

            if (!formData.ciudadano.trim()) {
              showNotification('Ingrese el nombre del ciudadano afectado', 'error');
              return false;
            }

            if (!formData.ubicacion.trim()) {
              showNotification('Especifique la ubicaci√≥n de la emergencia', 'error');
              return false;
            }

            return true;
          };

          // Enviar emergencia
          const handleSubmit = async () => {
            if (!validateForm()) return;

            setIsSubmitting(true);

            try {
              const servicioSeleccionado = servicios.find(s => s.value === formData.servicio);
              const timestamp = new Date().toISOString();
              
              const embed = {
                title: "üö® ALERTA VERIFICADA:",
                description: `**${formData.servicio}**\n\n**${formData.incidente}**`,
                color: parseInt(servicioSeleccionado.color.replace('#', ''), 16),
                fields: [
                  {
                    name: "üë§ Ciudadano (IC)",
                    value: formData.ciudadano,
                    inline: false
                  },
                  {
                    name: "üìç Ubicaci√≥n",
                    value: formData.ubicacion,
                    inline: false
                  },
                  {
                    name: "üîí Identidad Verificada",
                    value: "‚úì Confirmada",
                    inline: false
                  },
                  {
                    name: "Solicitado por:",
                    value: `@${discordUser.username}`,
                    inline: false
                  }
                ],
                footer: {
                  text: `@ Rangos Policiales: ${formData.rangos}`,
                  icon_url: "https://cdn.discordapp.com/embed/avatars/0.png"
                },
                timestamp: timestamp,
                thumbnail: {
                  url: `https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png`
                }
              };

              const webhookPayload = {
                username: 'Central 112 Valencia',
                avatar_url: 'https://cdn-icons-png.flaticon.com/512/3588/3588592.png',
                embeds: [embed]
              };

              console.log('Enviando a webhook...', webhookPayload);

              const response = await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(webhookPayload)
              });

              if (response.ok || response.status === 204) {
                showNotification('‚úì Emergencia reportada exitosamente', 'success');
                // Limpiar formulario
                setFormData({
                  servicio: '',
                  incidente: '',
                  ciudadano: '',
                  ubicacion: '',
                  rangos: 9
                });
              } else {
                const errorText = await response.text();
                console.error('Error del webhook:', response.status, errorText);
                showNotification('Error al procesar la solicitud. Intente nuevamente.', 'error');
              }
            } catch (error) {
              console.error('Error de conexi√≥n:', error);
              showNotification('Error de conexi√≥n. Verifique su internet.', 'error');
            } finally {
              setIsSubmitting(false);
            }
          };

          // Mostrar notificaci√≥n
          const showNotification = (message, type) => {
            setNotification({ show: true, message, type });
            setTimeout(() => {
              setNotification({ show: false, message: '', type: '' });
            }, 4000);
          };

          // Pantalla de carga
          if (isLoadingUser) {
            return (
              <div className="min-h-screen bg-slate-50 flex items-center justify-center">
                <div className="text-center">
                  <div className="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto mb-4"></div>
                  <p className="text-slate-600 font-semibold">Cargando sistema...</p>
                </div>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
              {/* Header */}
              <header className="bg-white border-b border-slate-200 shadow-sm sticky top-0 z-50">
                <div className="max-w-7xl mx-auto px-4 sm:px-6 py-4">
                  <div className="flex flex-col sm:flex-row items-center justify-between gap-4">
                    <div className="flex items-center gap-3">
                      <div className="w-12 h-12 bg-red-600 rounded-lg flex items-center justify-center flex-shrink-0">
                        <Phone className="w-7 h-7 text-white" />
                      </div>
                      <div>
                        <h1 className="text-xl sm:text-2xl font-bold text-slate-900">112 Valencia</h1>
                        <p className="text-xs sm:text-sm text-slate-600">Sistema de Gesti√≥n de Emergencias</p>
                      </div>
                    </div>
                    
                    <div className="flex items-center gap-4">
                      <div className="flex items-center gap-2 text-slate-600">
                        <Clock className="w-4 h-4" />
                        <span className="text-sm font-medium">
                          {currentTime.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' })}
                        </span>
                      </div>
                      
                      {discordUser && (
                        <div className="flex items-center gap-2 bg-slate-50 px-3 py-2 rounded-lg border border-slate-200">
                          <img 
                            src={`https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png`}
                            alt="Avatar"
                            className="w-8 h-8 rounded-full"
                          />
                          <div className="text-left hidden sm:block">
                            <p className="text-sm font-semibold text-slate-900">{discordUser.username}</p>
                            <p className="text-xs text-slate-500">Operador</p>
                          </div>
                          <button
                            onClick={handleLogout}
                            className="ml-2 text-xs text-slate-500 hover:text-slate-700 font-medium"
                            title="Cerrar sesi√≥n"
                          >
                            Salir
                          </button>
                        </div>
                      )}
                    </div>
                  </div>
                </div>
              </header>

              {/* Main Content */}
              <main className="max-w-7xl mx-auto px-4 sm:px-6 py-8">
                {!discordUser ? (
                  <div className="max-w-md mx-auto mt-20">
                    <div className="bg-white rounded-2xl shadow-lg border border-slate-200 p-8 sm:p-10 text-center">
                      <div className="w-20 h-20 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-6">
                        <Shield className="w-10 h-10 text-blue-600" />
                      </div>
                      <h2 className="text-2xl font-bold text-slate-900 mb-3">Autenticaci√≥n Requerida</h2>
                      <p className="text-slate-600 mb-2">
                        Para acceder al sistema de emergencias es necesario verificar su identidad.
                      </p>
                      <p className="text-sm text-slate-500 mb-8">
                        Inicie sesi√≥n con su cuenta de Discord para continuar.
                      </p>
                      <button
                        onClick={handleDiscordLogin}
                        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-3 shadow-sm"
                      >
                        <LogIn className="w-5 h-5" />
                        Iniciar Sesi√≥n con Discord
                      </button>
                    </div>
                  </div>
                ) : (
                  <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    {/* Panel Principal */}
                    <div className="lg:col-span-2 space-y-6">
                      {/* Selecci√≥n de Servicio */}
                      <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 className="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                          <AlertCircle className="w-5 h-5 text-red-600" />
                          Seleccionar Servicio de Emergencia
                        </h3>
                        <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                          {servicios.map((servicio) => (
                            <button
                              key={servicio.value}
                              onClick={() => setFormData({...formData, servicio: servicio.value})}
                              className={`relative p-6 rounded-xl border-2 transition-all ${
                                formData.servicio === servicio.value
                                  ? 'border-blue-600 bg-blue-50 shadow-md scale-105'
                                  : 'border-slate-200 hover:border-slate-300 hover:bg-slate-50'
                              }`}
                            >
                              <div className="text-center">
                                <div className="text-4xl mb-2">{servicio.icon}</div>
                                <p className="font-semibold text-slate-900 text-sm mb-1">{servicio.value}</p>
                                <p className="text-xs text-slate-500">{servicio.description}</p>
                              </div>
                              {formData.servicio === servicio.value && (
                                <div className="absolute top-2 right-2">
                                  <CheckCircle className="w-5 h-5 text-blue-600" />
                                </div>
                              )}
                            </button>
                          ))}
                        </div>
                      </div>

                      {/* Informaci√≥n del Incidente */}
                      <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 className="text-lg font-bold text-slate-900 mb-4">Informaci√≥n del Incidente</h3>
                        <div className="space-y-4">
                          <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-2">
                              Tipo de Incidente *
                            </label>
                            <input
                              type="text"
                              value={formData.incidente}
                              onChange={(e) => setFormData({...formData, incidente: e.target.value})}
                              placeholder="Describa brevemente la situaci√≥n de emergencia"
                              className="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all text-slate-900"
                              maxLength="200"
                            />
                            <p className="text-xs text-slate-500 mt-1">{formData.incidente.length}/200 caracteres</p>
                          </div>

                          <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                              <User className="w-4 h-4" />
                              Ciudadano Afectado (IC) *
                            </label>
                            <input
                              type="text"
                              value={formData.ciudadano}
                              onChange={(e) => setFormData({...formData, ciudadano: e.target.value})}
                              placeholder="Nombre completo del ciudadano"
                              className="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all text-slate-900"
                            />
                          </div>

                          <div>
                            <label className="block text-sm font-semibold text-slate-700 mb-2 flex items-center gap-2">
                              <MapPin className="w-4 h-4" />
                              Ubicaci√≥n Exacta *
                            </label>
                            <input
                              type="text"
                              value={formData.ubicacion}
                              onChange={(e) => setFormData({...formData, ubicacion: e.target.value})}
                              placeholder="Direcci√≥n, punto de referencia o coordenadas"
                              className="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all text-slate-900"
                            />
                          </div>
                        </div>
                      </div>

                      {/* Configuraci√≥n Adicional */}
                      <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 className="text-lg font-bold text-slate-900 mb-4 flex items-center gap-2">
                          <Hash className="w-5 h-5" />
                          Rangos Policiales a Notificar
                        </h3>
                        <div className="space-y-3">
                          <div className="flex items-center justify-between">
                            <span className="text-sm font-medium text-slate-700">Nivel de alerta:</span>
                            <span className="text-2xl font-bold text-blue-600">{formData.rangos}</span>
                          </div>
                          <input
                            type="range"
                            min="1"
                            max="20"
                            value={formData.rangos}
                            onChange={(e) => setFormData({...formData, rangos: parseInt(e.target.value)})}
                            className="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-blue-600"
                          />
                          <div className="flex justify-between text-xs text-slate-500 font-medium">
                            <span>M√≠nimo (1)</span>
                            <span>M√°ximo (20)</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Panel Lateral */}
                    <div className="space-y-6">
                      {/* Informaci√≥n del Operador */}
                      <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 className="text-sm font-bold text-slate-700 mb-4 uppercase tracking-wide">Operador del Sistema</h3>
                        <div className="flex items-start gap-3 mb-4">
                          <img 
                            src={`https://cdn.discordapp.com/avatars/${discordUser.id}/${discordUser.avatar}.png`}
                            alt="Avatar"
                            className="w-16 h-16 rounded-lg border-2 border-slate-200"
                          />
                          <div className="flex-1">
                            <p className="font-bold text-slate-900 text-lg">{discordUser.username}</p>
                            <div className="flex items-center gap-1 mt-1">
                              <div className="w-2 h-2 bg-green-500 rounded-full status-dot"></div>
                              <span className="text-xs text-slate-600">Verificado y activo</span>
                            </div>
                          </div>
                        </div>
                        <div className="bg-green-50 border border-green-200 rounded-lg p-3 flex items-center gap-2">
                          <Shield className="w-5 h-5 text-green-600 flex-shrink-0" />
                          <div>
                            <p className="text-xs font-semibold text-green-900">Identidad Verificada</p>
                            <p className="text-xs text-green-700">Autorizado para reportes</p>
                          </div>
                        </div>
                      </div>

                      {/* Estado del Sistema */}
                      <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 className="text-sm font-bold text-slate-700 mb-4 uppercase
